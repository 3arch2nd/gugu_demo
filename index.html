<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>곱셈구구 첫걸음</title>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
    <style>
        /* ========================================================= */
        /* 기본 스타일 (Base Styles) */
        /* ========================================================= */
        body {
            font-family: 'Gowun Dodum', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f7f6;
            color: #333;
            text-align: center;
            font-size: 18px;
        }
        .container {
            position: relative;
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 1100px;
            text-align: center;
            margin: 20px auto;
            box-sizing: border-box;
            min-height: 70vh;
            display: none;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            color: #4b8134;
            margin-bottom: 20px;
            font-size: 2.5em;
        }
        h2 {
            color: #333;
            margin-bottom: 5px;
            font-size: 1.8em;
        }
        button {
            font-family: 'Gowun Dodum', sans-serif;
            padding: 12px 24px;
            margin: 5px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2em;
            transition: background-color 0.3s, transform 0.1s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .primary-btn {
            background-color: #a0c179;
            color: white;
            font-weight: bold;
        }
        .primary-btn:hover {
            background-color: #8cb24b;
        }
        .secondary-btn {
            background-color: #e9e9e9;
            color: #333;
            border: 2px solid #ccc;
        }
        .secondary-btn:hover {
            background-color: #d9d9d9;
        }
        .footer {
            margin-top: 20px;
            font-size: 14px;
            color: #ccc;
            text-align: center;
        }

        /* ========================================================= */
        /* 공통 헤더 및 QR 버튼 */
        /* ========================================================= */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
        }
        .page-header h2 {
            flex-grow: 1;
            text-align: center;
            margin: 0;
            padding-left: 20px;
            padding-right: 20px;
        }
        .home-button {
            background-color: #e9e9e9;
            color: #333;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 1em;
            cursor: pointer;
            text-decoration: none;
            font-weight: bold;
            flex-shrink: 0;
        }
        #qr-code-btn {
            background-color: #e9e9e9;
            color: #333;
            padding: 5px 10px;
            font-size: 0.9em;
            position: absolute;
            top: 30px;
            right: 30px;
            z-index: 10;
        }

        /* ========================================================= */
        /* 첫 페이지 (Home Page) - 크기 및 간격 조정 */
        /* ========================================================= */
        #home-page { justify-content: center; }
        #home-page h1 { margin-top: 50px; margin-bottom: 50px; }
        #home-page .level-buttons { display: flex; justify-content: center; gap: 20px; /* 간격 축소 */ width: 100%; margin-top: 0; }
        #home-page .level-option { flex: 1; display: flex; flex-direction: column; align-items: center; max-width: 300px; }
        #home-page .level-option button { 
            padding: 40px 50px; /* 패딩 증가 */ 
            font-size: 2.0em; /* 폰트 크기 증가 */ 
            width: 100%; 
            background-color: #ffda79; 
            color: #333; 
            font-weight: bold; 
        }
        .level-description { white-space: pre-line; margin-top: 15px; font-size: 1.1em; color: #6c757d; line-height: 1.4; min-height: 90px; text-align: center; }

        /* ========================================================= */
        /* 1, 2, 3단계 공통 레이아웃 & 버튼 너비 최소화 */
        /* ========================================================= */
        .page-content-layout {
            display: flex;
            width: 100%;
            text-align: left;
            flex-grow: 1;
        }
        .left-panel {
            width: 100px;
            margin-right: 20px;
            position: relative;
            padding-top: 15px; /* 간격 조정 */
            flex-shrink: 0;
        }
        .right-main-area {
            flex-grow: 1;
            padding-left: 20px;
            border-left: 1px solid #eee;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .gugudan-select-vertical {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .gugudan-select-vertical button {
            padding: 8px 5px;
            font-size: 1em;
            width: 100%;
            margin: 0;
        }
        /* 1, 2단계: 방향 버튼 디자인 개선 (유니코드 화살표) */
        .direction-random-btn {
            padding: 8px 5px;
            font-size: 1.2em; /* 화살표 크기 조정 */
            width: 100%;
            font-weight: bold;
            margin-bottom: 8px; 
            
            /* 기본(←, 역방향) 스타일 */
            background-color: #6c757d; 
            color: white;
            line-height: 1; 
        }
        .direction-random-btn.direction-active-forward {
            /* 정방향(→) 활성화 스타일 */
            background-color: #ffc107; 
            color: #333;
        }
        .direction-random-btn.direction-active-reverse {
             /* 역방향(←) 활성화 스타일 (기본 스타일로 대체) */
            background-color: #6c757d;
            color: white;
        }
        /* 3단계 '섞어요!' 버튼 스타일 */
        #level3-random-btn {
            font-size: 0.9em; /* 텍스트 크기는 작게 유지 */
            background-color: #e9e9e9; 
            color: #333; 
            border: 2px solid #ccc; 
            line-height: normal; /* 텍스트이므로 normal */
        }
        #level3-random-btn.selected { 
            background-color: #dc3545;
            color: white;
            font-weight: bold;
            border-color: #dc3545; 
        }

        /* ========================================================= */
        /* 3. 단 선택 버튼 무지개 색상 팔레트 (HEX 변경) */
        /* ========================================================= */
        .gugudan-btn-2.selected { background-color: #ea9999; color: white; font-weight: bold; } /* 2단 색상 변경 */
        .gugudan-btn-3.selected { background-color: #f7952f; color: white; font-weight: bold; }
        .gugudan-btn-4.selected { background-color: #ffd966; color: #333; font-weight: bold; }
        .gugudan-btn-5.selected { background-color: #cfed8c; color: #333; font-weight: bold; }
        .gugudan-btn-6.selected { background-color: #85ba6e; color: white; font-weight: bold; }
        .gugudan-btn-7.selected { background-color: #abe7f0; color: #333; font-weight: bold; }
        .gugudan-btn-8.selected { background-color: #559ad9; color: white; font-weight: bold; }
        .gugudan-btn-9.selected { background-color: #b4a7d6; color: white; font-weight: bold; }

        /* ========================================================= */
        /* 1단계 (Matching Game) - 카드 크기 재조정 및 레이아웃 수정 */
        /* ========================================================= */
        .card-row {
            display: flex;
            justify-content: flex-start;
            gap: 10px; /* 간격 재조정 */
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 5px;
            width: 100%;
        }
        .card {
            width: 65px; /* 너비 재조정 (65px) */
            height: 65px; /* 높이 재조정 (65px) */
            line-height: 65px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 3px solid #ccc;
            border-radius: 8px;
            font-size: 1.5em; /* 글자 크기 유지 */
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            flex-shrink: 0;
            box-sizing: border-box; 
        }
        /* 곱셈식 줄바꿈 방지 및 너비 맞추기 */
        .card.problem-card {
            letter-spacing: -1px; /* 글자 간 간격 줄이기 */
            padding-top: 2px; /* 세로 중앙 정렬 미세 조정 */
            border-color: #ccc; /* 기본 색 유지 */
            color: #333;
            background-color: #f7f7f7; /* 배경색 추가 */
        }
        .card.matched-problem {
            border-color: #4b8134; /* 매칭된 문제 초록색 테두리 */
            background-color: #e6f3d9; /* 매칭된 문제 연두색 배경 */
            cursor: default;
        }

        .card-placeholder {
            width: 65px; /* 너비 재조정 */
            height: 65px; /* 높이 통일 */
            line-height: 65px;
            border: 3px dashed #eee;
            border-radius: 8px;
            flex-shrink: 0;
            background-color: transparent;
            cursor: default;
            box-sizing: border-box; /* 크기 일치 보장 */
        }
        .card.selected { transform: scale(1.05); border-color: #ffc107; box-shadow: 0 0 15px rgba(255, 193, 7, 0.8); background-color: #fffbe0; }
        
        /* 매칭된 답 카드가 들어가는 스타일 (placeholder를 대체) */
        .card.matched-answer { 
            border: 3px solid #ccc;
            background-color: white; /* 일반 답 카드보다 더 밝게 */
            color: #333; 
            margin: 0; 
            padding: 0; 
            height: 65px; 
            line-height: 65px; 
            font-size: 1.5em; 
            letter-spacing: normal;
        }
        
        /* 1단계 맞춘 카드 행 표시 및 간격 조정 */
        #level1-matched-row { 
            display: flex; 
            margin-top: 5px; 
            margin-bottom: 20px; 
            justify-content: flex-start;
            gap: 10px;
        }

        #level1-unmatched-answers-row { margin-top: 20px; min-height: 60px; } 
        #level1-problem-row { margin-bottom: 0; }
        #level1-page .right-main-area > p { margin-bottom: 10px; }
        .completion-message {
            margin-top: 50px;
            padding: 20px;
            border: none;
            border-radius: 12px;
            background-color: transparent; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); 
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            font-size: 1.5em;
            color: #4b8134;
            font-weight: bold;
        }
        .completion-message p { margin: 10px 0; font-size: 0.8em; color: #333; }
        .completion-message .popup-buttons { margin-top: 15px; }
        .completion-message .popup-buttons button {
            padding: 0 10px; 
            font-size: 0.8em; 
            min-width: 120px;
            height: 35px; 
            line-height: 35px; 
            display: inline-block; 
        }

        /* ========================================================= */
        /* 2단계 (Fill-in-the-Blank) - 카드 크기 재조정 */
        /* ========================================================= */
        .level2-control-area {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 20px;
            width: 100%;
        }
        #level2-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #level2-control p { flex-shrink: 0; }
        #level2-control button {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            padding: 0;
            margin: 0;
            font-size: 1.5em;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }
        .quantity-display {
            font-size: 2.2em;
            font-weight: bold;
            color: #4b8134;
            width: 40px;
            text-align: center;
            flex-shrink: 0;
        }
        #level2-control .primary-btn,
        #level2-control .secondary-btn:last-child {
            padding: 8px 15px;
            font-size: 1.1em;
            width: auto;
            height: auto;
            border-radius: 10px;
        }
        .level2-problem-area { 
            flex-direction: column;
            flex-grow: 1;
        }
        .level2-problem-row {
            display: flex;
            justify-content: flex-start;
            gap: 10px; /* 간격 재조정 */
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        .level2-problem-text {
            width: 65px; /* 너비 재조정 */
            height: 65px; /* 높이 재조정 */
            line-height: 65px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 3px solid #4b8134;
            border-radius: 8px;
            font-size: 1.5em; 
            font-weight: bold;
            color: #4b8134;
            flex-shrink: 0;
            box-sizing: border-box;
            letter-spacing: -1px; /* 글자 간 간격 줄이기 */
            padding-top: 2px; /* 세로 중앙 정렬 미세 조정 */
        }
        .level2-pair { 
            width: 65px; /* 너비 재조정 */
            flex-shrink: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 5px; 
        }
        .level2-answer-box { 
            width: 65px; /* 너비 재조정 */
            height: 65px;
            line-height: 65px;
            border: 3px solid #ccc;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em; 
            font-weight: bold;
            background-color: #f7f7f7;
            box-sizing: border-box;
        }
        .level2-answer-box.flipped { background-color: #fff; padding: 0; }
        .level2-input {
            width: 60px; /* 카드 보더 제외하고 꽉 차게 */
            height: 60px; /* 카드 보더 제외하고 꽉 차게 */
            font-family: 'Gowun Dodum', sans-serif;
            font-size: 1.5em; /* 폰트 크기 조정 (0.8배) */
            text-align: center;
            border: 2px solid #ffc107;
            border-radius: 4px;
            box-sizing: border-box;
            line-height: 60px;
            padding: 0;
            margin: 0;
        }
        .level2-input::-webkit-outer-spin-button,
        .level2-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .level2-input[type=number] { -moz-appearance: textfield; }
        .level2-pair.incorrect .level2-answer-box {
            border-color: #dc3545;
            background-color: #fff0f0;
        }
        .level2-pair.incorrect .level2-problem-text {
            color: #dc3545;
            border-color: #dc3545;
        }
        /* 2단계 오류 메시지 크기 조정 */
        #level2-completion-message p { 
            font-size: 0.9em; 
            line-height: 1.4; 
        }


        /* ========================================================= */
        /* 3단계 (Quiz) - UI 및 버튼 */
        /* ========================================================= */
        #level3-mode-select-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
        }
        #level3-mode-select {
            display: flex;
            justify-content: center;
            gap: 50px;
            margin-bottom: 0;
            width: 100%;
        }
        /* 3단계 '직접 입력' 버튼 스타일 수정 */
        #level3-mode-select button#mode-input-btn {
            border: none;
            font-weight: bold;
        }
        #level3-mode-select button {
            padding: 30px 50px;
            font-size: 1.8em;
            width: 300px;
            max-width: 40%;
            height: 120px;
        }
        #level3-mode-select button#mode-4choice-btn {
            background-color: #ffc107;
            color: #333;
        }
        #level3-mode-select button#mode-4choice-btn:hover { background-color: #fdb827; }
        #level3-mode-select button#mode-input-btn {
            background-color: #e06666;
            color: white;
        }
        #level3-mode-select button#mode-input-btn:hover { background-color: #cc4125; }
        .mode-select-guide {
            font-size: 1.4em;
            color: #6c757d;
            margin-bottom: 40px;
            font-weight: bold;
        }
        /* 3단계 문제 영역 */
        .level3-problem-area { 
            font-size: 3.8em; 
            margin: 40px 0 30px 0; 
            min-height: 100px; 
            text-align: center; 
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px; 
        } 
        /* 3단계 4지선다형 레이아웃 */
        .level3-options-area {
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 3px; /* 간격 축소 */
            margin: 25px auto 30px auto; 
            max-width: 800px; /* 너비 확장 */
        }
        .level3-options-area button { 
            width: 140px; /* 너비 확장 */
            height: 80px; /* 버튼 높이 확장 */
            padding: 5px;
            font-size: 2.2em; /* 폰트 크기 확장 */
            margin: 0;
            background-color: white;
            color: #333;
            border: 3px solid #ccc;
            line-height: 70px; /* 텍스트 수직 중앙 정렬 */
            transition: background-color 0.1s, transform 0.1s, border-color 0.2s;
        }
        .level3-options-area button:hover {
             border-color: #8cb24b;
             background-color: #f7fff3;
        }
        .level3-result-message.correct-msg { color: #4b8134; }
        .level3-result-message.incorrect-msg { color: #dc3545; }
        /* 3단계 직접 입력 레이아웃 */
        .level3-input-area { 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            gap: 20px; 
            margin-top: 25px; 
        } 
        #level3-problem-text { 
            font-size: 1em; 
            margin: 0;
        }
        #level3-answer-input { 
            width: 100px; 
            height: 60px; 
            font-size: 1.0em; 
            text-align: center; 
            border: 3px solid #ccc; 
            border-radius: 8px; 
            padding: 0;
            box-sizing: border-box;
            background-color: transparent; 
            color: #333; 
            font-weight: normal; 
        }
        #level3-answer-input::-webkit-outer-spin-button,
        #level3-answer-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .level3-input[type=number] { -moz-appearance: textfield; }
        #level3-submit-btn { 
            padding: 10px 25px; 
            font-size: 1.6em; 
            background-color: #4b8134; 
            color: white; 
            width: auto; 
        }
        .level3-result-message { margin-top: 20px; font-size: 1.2em; font-weight: bold; min-height: 30px; text-align: center; }

        #level3-quiz-area .right-main-area > div:last-child { 
            margin-top: 25px; 
        }
        #level3-status {
            font-size: 1.1em;
            color: #6c757d;
            font-weight: bold;
            min-height: 30px;
            margin-bottom: 15px; 
            text-align: center;
        }
        .status-accuracy { color: #4b8134; font-size: 1.2em; }

        /* ========================================================= */
        /* 3단계 결과 페이지 */
        /* ========================================================= */
        #level3-result-page {
            justify-content: center;
            align-items: center;
            text-align: center;
            padding-top: 50px;
        }
        #level3-result-page h3 {
            font-size: 2.2em;
            color: #4b8134;
            margin-bottom: 50px;
        }
        .final-result-layout {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            max-width: 700px;
            margin-bottom: 60px;
            padding: 30px;
            border-radius: 15px;
            background-color: #e6f3d9;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        .result-left {
            flex-grow: 1;
            text-align: center;
            padding-right: 30px;
            border-right: 2px dashed #ccc;
        }
        .result-right {
            flex-grow: 1;
            text-align: left;
            padding-left: 30px;
            font-size: 1.2em;
            line-height: 2.0;
        }
        #final-accuracy {
            font-size: 6em;
            font-weight: bold;
            color: #dc3545;
            line-height: 1.1;
        }
        .result-right strong { color: #1e90ff; font-size: 1.1em; }

        /* ========================================================= */
        /* 팝업 및 경고 & QR 코드 추가 */
        /* ========================================================= */
        .popup-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.6); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 900; 
            transition: opacity 0.3s; 
        }
        .popup-qr { z-index: 1000; background-color: rgba(255, 255, 255, 0.9); }
        .popup-box { background-color: white; padding: 40px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3); position: relative; width: 80%; max-width: 500px; text-align: center; }
        .close-btn-qr { position: absolute; top: 10px; right: 10px; padding: 5px 10px; }
        .qr-image-box { margin-top: 20px; }
        .qr-image-box img { max-width: 250px; width: 100%; height: auto; border: 1px solid #eee; border-radius: 8px; }
        
        #orientation-warning {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); color: white; z-index: 999; display: none; flex-direction: column; justify-content: center; align-items: center; font-size: 1.5em; text-align: center; line-height: 1.5; padding: 20px;
        }
        @media (max-aspect-ratio: 1/1) and (max-width: 1100px) {
            #orientation-warning { display: flex; }
            .container { display: none !important; }
        }
        @media (min-aspect-ratio: 1/1) and (min-width: 768px) {
            #orientation-warning { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="orientation-warning">
        <p>기기를 가로 방향으로 돌려주세요! 🔄</p>
    </div>

    <div id="home-page" class="container" style="display: flex;">
        <button id="qr-code-btn" class="secondary-btn" onclick="openQrPopup()">QR 코드</button>
        
        <h1>곱셈구구 첫걸음</h1>

        <div class="level-buttons">
            <div class="level-option">
                <button class="primary-btn" onclick="startLevel(1, 2)">1단계</button>
                <p class="level-description">문제 카드와 답 카드를
짝지어 연결해요.</p>
            </div>
            <div class="level-option">
                <button class="primary-btn" onclick="startLevel(2, 2)">2단계</button>
                <p class="level-description">카드들이 사라졌어요!
빈칸에 알맞은 답을
직접 채워요.</p>
            </div>
            <div class="level-option">
                <button class="primary-btn" onclick="startLevel(3)">3단계</button>
                <p class="level-description">답 고르기 또는 직접 입력으로
곱셈구구 실력을 길러요.</p>
            </div>
        </div>

    </div>

    <div id="level1-page" class="container">
        <div class="page-header">
            <button class="home-button" onclick="showPage('home-page')">처음으로 돌아가기</button>
            <h2>1단계: 짝 맞추기</h2>
            <span style="visibility: hidden; width: 80px;">QR 코드</span>
        </div>
        
        <div class="page-content-layout">
            <div class="left-panel">
                <button id="direction-btn" class="direction-random-btn secondary-btn" onclick="toggleDirection(1)">&#8678;</button>
                <div class="gugudan-select-vertical" id="level1-gugudan-select"></div>
            </div>

            <div class="right-main-area">
                <p style="font-size: 1.1em; color: #6c757d; text-align: left;">문제 카드 (클릭해서 선택하세요)</p>
                <div id="level1-problem-row" class="card-row"></div>
                
                <div id="level1-matched-row" class="card-row"></div>

                <p style="font-size: 1.1em; color: #6c757d; text-align: left; margin-top: 20px;">답 카드 (클릭해서 선택하세요)</p>
                <div id="level1-unmatched-answers-row" class="card-row"></div>
                
                <div id="level1-completion-message" class="completion-message" style="display: none;"></div>
            </div>
        </div>
    </div>
    
    <div id="level2-page" class="container">
        <div class="page-header">
            <button class="home-button" onclick="showPage('home-page')">처음으로 돌아가기</button>
            <h2>2단계: 빈칸 채우기</h2>
            <span style="visibility: hidden; width: 80px;">QR 코드</span>
        </div>

        <div class="page-content-layout">
            <div class="left-panel">
                <button id="direction-btn-l2" class="direction-random-btn secondary-btn" onclick="toggleDirection(2)">&#8678;</button>
                <div class="gugudan-select-vertical" id="level2-gugudan-select"></div>
            </div>

            <div class="right-main-area">
                <div class="level2-control-area">
                    <div id="level2-control">
                        <p style="font-size: 1.1em; margin: 0;">뒤집을 카드 개수:</p>
                        <button class="secondary-btn" onclick="changeFlipCount(-1)">-</button>
                        <span class="quantity-display" id="flip-count-display">1</span>
                        <button class="secondary-btn" onclick="changeFlipCount(1)">+</button>
                        <button id="flip-cards-btn" class="primary-btn" onclick="flipRandomCards()">뒤집어요!</button>
                        <button class="secondary-btn" onclick="checkLevel2Answers()">확인</button>
                    </div>
                </div>

                <div class="level2-problem-area">
                    <p style="font-size: 1.1em; color: #6c757d; text-align: left;">빈칸에 답을 입력하고 확인 버튼을 누르세요</p>
                    <div id="level2-problem-area-row" class="level2-problem-row"></div>
                </div>
                
                <div id="level2-completion-message" class="completion-message" style="display: none;"></div>
            </div>
        </div>
    </div>

    <div id="level3-page" class="container">
        <div class="page-header">
            <button class="home-button" onclick="showPage('home-page')">처음으로 돌아가기</button>
            <h2>3단계: 실력 기르기</h2>
            <span style="visibility: hidden; width: 80px;">QR 코드</span>
        </div>

        <div id="level3-mode-select-wrapper">
            <p class="mode-select-guide">원하는 문제 유형을 골라보세요</p>
            <div id="level3-mode-select">
                <button id="mode-4choice-btn" class="primary-btn" onclick="selectLevel3Mode('4choice')">답 고르기</button>
                <button id="mode-input-btn" class="secondary-btn" onclick="selectLevel3Mode('input')">직접 입력</button>
            </div>
        </div>

        <div id="level3-quiz-area" style="display: none; flex-grow: 1; width: 100%;">
            <div class="page-content-layout">
                <div class="left-panel">
                    <button id="level3-random-btn" class="direction-random-btn secondary-btn" onclick="toggleRandomMode()">섞어요!</button>
                    <div class="gugudan-select-vertical" id="level3-gugudan-select"></div>
                </div>

                <div class="right-main-area" style="justify-content: center; align-items: center; text-align: center;">
                    
                    <div style="width: 100%;">
                        
                        <div id="level3-problem-area" class="level3-problem-area">
                        </div>
                        
                        <div id="level3-options-area" class="level3-options-area"></div>
                        
                        <div id="level3-input-area" class="level3-input-area" style="display: none;">
                            <button id="level3-submit-btn" class="primary-btn" onclick="checkLevel3Answer()">정답 확인</button>
                        </div>
                        
                        <div id="level3-result-message" class="level3-result-message"></div>
                    </div>

                    <div style="margin-top: 25px; text-align: center;"> 
                        <div id="level3-status">0문제를 풀었어요! 정확도: <span class="status-accuracy">100%</span></div>
                        <button class="secondary-btn" onclick="finishLevel3()">연습 끝!</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div id="level3-result-page" class="container" style="display: none;">
        <h3>✨ 최종 연습 결과 ✨</h3>
        <div class="final-result-layout">
            <div class="result-left">
                <p style="font-size: 1.5em; margin-bottom: 5px;">나의 정확도</p>
                <div id="final-accuracy">0%</div>
            </div>
            <div class="result-right">
                <p>도전한 전체 문제 수: <strong id="result-total-count">0</strong>개</p>
                <p>한 번에 맞춘 문제: <strong id="result-first-try">0</strong>개</p>
                <p>다시 도전해서 맞춘 문제: <strong id="result-retry-count">0</strong>개</p>
            </div>
        </div>
        <div class="popup-buttons">
            <button class="secondary-btn" onclick="showPage('home-page')">처음으로 돌아가기</button>
            <button class="primary-btn" onclick="startLevel(3)">3단계 다시 시작</button>
        </div>
    </div>

    <div id="popup-overlay" class="popup-overlay" style="display: none;">
        <div class="popup-box">
            <h2 id="popup-title"></h2>
            <p id="popup-message"></p>
            <div class="popup-buttons" id="popup-buttons"></div>
        </div>
    </div>
    
    <div id="qr-popup-overlay" class="popup-overlay popup-qr" style="display: none;">
        <div class="popup-box">
            <button class="secondary-btn close-btn-qr" onclick="closeQrPopup()">X</button>
            <h3>QR 코드</h3>
            <div class="qr-image-box">
                <img src="https://i.imgur.com/tONLfMo.png" alt="앱 접속 QR 코드">
            </div>
        </div>
    </div>

    <div class="footer">
        Copyright © 2025 휴르쌤. All rights reserved.
    </div>

    <script>
        // 상태 변수
        let currentPage = 'home-page';
        let currentGuGuDan = 2;
        let isReverse = false;

        let selectedProblemCard = null;
        let selectedAnswerCard = null;
        let level1Problems = [];
        let level1Answers = [];
        let matchedPairs = 0;

        let level2FlipCount = 1;
        let level2ProblemSet = [];
        let flippedIndices = [];

        let level3Mode = '4choice';
        let selectedGugudans = new Set();
        let isLevel3Random = false;
        let level3CurrentProblem = null;
        let level3Attempts = {}; 
        let level3Accuracy = {
            totalProblems: 0,
            correctOnFirstTry: 0,
            retryCorrect: 0, 
            scoreSum: 0, 
        };
        
        // 3단계 문제 풀 생성기
        const level3QuizGenerator = {
            availableProblems: {}, 
            initDan(dan) {
                this.availableProblems[dan] = Array.from({length: 9}, (_, i) => i + 1);
                shuffle(this.availableProblems[dan]); 
            },
            initAllSelectedDans() {
                this.availableProblems = {};
                const allDans = Array.from({length: 8}, (_, i) => i + 2);
                const dansToInit = isLevel3Random || selectedGugudans.size === 0 ? allDans : Array.from(selectedGugudans);
                dansToInit.forEach(dan => this.initDan(dan));
            },
        };

        // DOM 요소
        const homePage = document.getElementById('home-page');
        const level1Page = document.getElementById('level1-page');
        const level2Page = document.getElementById('level2-page');
        const level3Page = document.getElementById('level3-page');
        const level3ResultPage = document.getElementById('level3-result-page');
        const popupOverlay = document.getElementById('popup-overlay');
        const qrPopupOverlay = document.getElementById('qr-popup-overlay');
        const orientationWarning = document.getElementById('orientation-warning');
        
        // 헬퍼
        function generateGugudanSet(dan, reverse) {
            const set = [];
            for (let i = 1; i <= 9; i++) {
                set.push({ 
                    problem: `${dan} x ${i}`, 
                    answer: dan * i, 
                    id: dan * 10 + i 
                });
            }
            return reverse ? set.reverse() : set;
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        function createPopupButton(className, text, onClick) {
            const btn = document.createElement('button');
            btn.className = className;
            btn.textContent = text;
            btn.onclick = onClick;
            return btn;
        }

        const DAN_COLORS = {
            2: '#ea9999', /* 2단 색상 변경 */
            3: '#f7952f', 
            4: '#ffd966', 
            5: '#cfed8c', 
            6: '#85ba6e', 
            7: '#abe7f0', 
            8: '#559ad9', 
            9: '#b4a7d6'
        };
        const DAN_TEXT_COLOR = {
            2: 'white', 3: 'white', 4: '#333', 5: '#333', 6: 'white', 7: '#333', 8: 'white', 9: 'white'
        };

        // 페이지 전환
        function showPage(pageId) {
            [homePage, level1Page, level2Page, level3Page, level3ResultPage].forEach(page => {
                if (page) page.style.display = 'none';
            });
            if (popupOverlay) popupOverlay.style.display = 'none'; 
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.style.display = 'flex';
                currentPage = pageId;
                if (pageId === 'level3-page') {
                    document.getElementById('level3-mode-select-wrapper').style.display = 'flex';
                    document.getElementById('level3-quiz-area').style.display = 'none';
                    document.getElementById('level3-result-page').style.display = 'none';
                }
            }
        }

        // 초기 시작
        function startLevel(level, dan = 2) {
            currentGuGuDan = dan;
            isReverse = false;

            if (level === 1) {
                setupGugudanButtons(1);
                showPage('level1-page');
                loadLevel1Cards(currentGuGuDan, isReverse);
                document.getElementById('level1-completion-message').style.display = 'none';
            } else if (level === 2) {
                setupGugudanButtons(2);
                showPage('level2-page');
                loadLevel2Cards(currentGuGuDan, isReverse);
                document.getElementById('level2-completion-message').style.display = 'none';
                document.getElementById('flip-cards-btn').disabled = false;
            } else if (level === 3) {
                showPage('level3-page');
            }
        }

        // 단 버튼 (1/2단계)
        function setupGugudanButtons(level) {
            const containerId = level === 1 ? 'level1-gugudan-select' : 'level2-gugudan-select';
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            for (let dan = 2; dan <= 9; dan++) {
                const btn = document.createElement('button');
                btn.className = `secondary-btn gugudan-btn-${dan}`;
                btn.textContent = `${dan}단`;
                btn.setAttribute('data-dan', dan);
                btn.onclick = () => { selectGuGuDan(level, dan); };
                container.appendChild(btn);
            }
            selectGuGuDan(level, currentGuGuDan);
        }

        function selectGuGuDan(level, dan) {
            currentGuGuDan = dan;
            
            const containerId = level === 1 ? 'level1-gugudan-select' : 'level2-gugudan-select';
            const directionBtnId = level === 1 ? 'direction-btn' : 'direction-btn-l2';
            
            document.querySelectorAll(`#${containerId} button`).forEach(btn => {
                const danNum = parseInt(btn.getAttribute('data-dan'));
                btn.classList.remove('selected');
                btn.style.backgroundColor = '#e9e9e9';
                btn.style.color = '#333';
                if (danNum === dan) {
                    btn.classList.add('selected');
                    btn.style.backgroundColor = DAN_COLORS[danNum];
                    btn.style.color = DAN_TEXT_COLOR[danNum];
                }
            });

            const directionBtn = document.getElementById(directionBtnId);
            
            // 방향 버튼 텍스트 업데이트 (innerHTML 사용)
            directionBtn.innerHTML = isReverse ? '&#8680;' : '&#8678;';
            
            directionBtn.classList.remove('direction-active-forward', 'direction-active-reverse');
            directionBtn.classList.add(isReverse ? 'direction-active-forward' : 'direction-active-reverse');

            if (level === 1) {
                loadLevel1Cards(dan, isReverse);
                document.getElementById('level1-completion-message').style.display = 'none';
            } else if (level === 2) {
                loadLevel2Cards(dan, isReverse);
                document.getElementById('level2-completion-message').style.display = 'none';
                document.getElementById('flip-cards-btn').disabled = false;
            }
        }

        function toggleDirection(level) {
            isReverse = !isReverse;
            const directionBtnId = level === 1 ? 'direction-btn' : 'direction-btn-l2';
            const directionBtn = document.getElementById(directionBtnId);

            // 방향 버튼 텍스트 업데이트 (innerHTML 사용)
            directionBtn.innerHTML = isReverse ? '&#8680;' : '&#8678;';

            directionBtn.classList.remove('direction-active-forward', 'direction-active-reverse');
            directionBtn.classList.add(isReverse ? 'direction-active-forward' : 'direction-active-reverse');

            if (level === 1) {
                loadLevel1Cards(currentGuGuDan, isReverse);
            } else if (level === 2) {
                loadLevel2Cards(currentGuGuDan, isReverse);
                document.getElementById('flip-cards-btn').disabled = false;
            }
        }

        /* ---------------- 1단계 ---------------- */
        
        function fillPlaceholders() {
            const matchedRow = document.getElementById('level1-matched-row');
            matchedRow.innerHTML = '';
            // 9개의 빈 카드를 미리 채움 (문제 카드 아래 고정)
            for (let i = 0; i < 9; i++) {
                const placeholder = document.createElement('div');
                placeholder.className = 'card-placeholder';
                placeholder.setAttribute('data-index', i); 
                matchedRow.appendChild(placeholder);
            }
        }

        function renderLevel1Cards() {
            const problemRow = document.getElementById('level1-problem-row');
            const answerRow = document.getElementById('level1-unmatched-answers-row');
            const matchedRow = document.getElementById('level1-matched-row');
            
            problemRow.innerHTML = '';
            answerRow.innerHTML = '';

            // 1. 문제 카드 렌더링
            level1Problems.forEach((item) => {
                const card = document.createElement('div');
                card.setAttribute('data-id', item.id);
                
                if (item.isMatched) {
                    card.className = 'card problem-card matched-problem'; 
                    card.textContent = item.problem;
                    card.onclick = null;
                } else {
                    card.className = `card problem-card ${selectedProblemCard && selectedProblemCard.id === item.id ? 'selected' : ''}`;
                    card.textContent = item.problem;
                    card.onclick = () => selectCard(item, 'problem', card);
                }
                problemRow.appendChild(card);
            });

            // 2. 맞춰진 답 카드를 제 위치(matched-row)에 채우기
            // matchedRow는 fillPlaceholders()에서 9개의 placeholder를 가지고 있습니다.
            level1Problems.forEach((item, index) => {
                const targetElement = matchedRow.children[index];
                if (!targetElement) return;

                if (item.isMatched) {
                    if (targetElement.classList.contains('card-placeholder')) {
                         // placeholder라면 정답 카드로 대체
                        const matchedAnswerCard = document.createElement('div');
                        matchedAnswerCard.className = 'card matched-answer';
                        matchedAnswerCard.textContent = item.answer;
                        matchedRow.replaceChild(matchedAnswerCard, targetElement);
                    }
                } else {
                    // 매칭되지 않은 상태일 경우: 해당 위치에 placeholder가 남아있는지 확인
                    if (!targetElement.classList.contains('card-placeholder')) {
                        // 정답 카드가 들어있다면 다시 placeholder로 되돌림
                        const placeholder = document.createElement('div');
                        placeholder.className = 'card-placeholder';
                        placeholder.setAttribute('data-index', index);
                        matchedRow.replaceChild(placeholder, targetElement);
                    }
                }
            });


            // 3. 미사용 답 카드를 아래쪽 answer-row에 렌더링 (빈 공간 유지)
            
            // 9개의 빈 칸을 먼저 준비 (점선 카드로)
            const answerRowCards = Array.from({length: 9}, (_, i) => {
                const placeholder = document.createElement('div');
                placeholder.className = 'card-placeholder';
                placeholder.setAttribute('data-index', i);
                return placeholder;
            });
            
            // 섞인 답 카드들 중 맞춰지지 않은 카드만 실제 답 카드로 대체
            level1Answers.forEach((answerItem, originalIndex) => {
                const problem = level1Problems.find(p => p.id === answerItem.id);
                
                // level1Answers 배열의 인덱스는 섞인 답 카드의 현재 위치를 의미합니다.
                const answerRowIndex = originalIndex;

                if (problem && !problem.isMatched) {
                    // 맞춰지지 않은 카드라면, 실제 답 카드 DOM 요소를 생성
                    const card = document.createElement('div');
                    card.className = `card answer-card ${selectedAnswerCard && selectedAnswerCard.id === answerItem.id ? 'selected' : ''}`;
                    card.textContent = answerItem.answer;
                    card.setAttribute('data-answer', answerItem.answer);
                    card.setAttribute('data-problem-id', answerItem.id);
                    card.onclick = () => selectCard(answerItem, 'answer', card);
                    
                    // answerRowCards 배열의 해당 위치를 실제 답 카드로 대체
                    answerRowCards[answerRowIndex] = card;
                } else {
                    // 이미 맞춘 카드라면, 그 자리에 미리 생성된 placeholder를 그대로 둡니다.
                }
            });

            // answerRow에 9개 카드(답 카드 또는 빈 카드)를 모두 추가
            answerRowCards.forEach(card => answerRow.appendChild(card));
        }

        function loadLevel1Cards(dan, reverse) {
            const gugudanSet = generateGugudanSet(dan, reverse);
            level1Problems = gugudanSet.map(item => ({...item, isMatched: false}));
            
            // level1Answers에는 섞인 답 카드 목록을 저장하며, 이 순서가 하단 답 카드 풀의 위치를 결정함
            let answers = gugudanSet.map(item => ({...item})); // id, answer, problem 포함
            level1Answers = shuffle(answers); 
            
            matchedPairs = 0;
            selectedProblemCard = null;
            selectedAnswerCard = null;
            
            fillPlaceholders(); // 상단 매칭 공간에 빈 카드 9개 미리 채우기
            renderLevel1Cards();
            document.getElementById('level1-completion-message').style.display = 'none';
        }
        
        function selectCard(item, type, element, pairContainer = null) {
            if (level1Problems.find(p => p.id === item.id)?.isMatched) return;

            if (type === 'problem' && selectedProblemCard && selectedProblemCard.id === item.id) {
                selectedProblemCard = null;
                element.classList.remove('selected');
            } else if (type === 'answer' && selectedAnswerCard && selectedAnswerCard.id === item.id) {
                selectedAnswerCard = null;
                element.classList.remove('selected');
            } 
            else if (type === 'problem') {
                if (selectedProblemCard) selectedProblemCard.element.classList.remove('selected');
                selectedProblemCard = {...item, element, index: level1Problems.findIndex(p => p.id === item.id)}; // index 저장
                element.classList.add('selected');
            } else if (type === 'answer') {
                if (selectedAnswerCard) selectedAnswerCard.element.classList.remove('selected');
                selectedAnswerCard = {...item, element};
                element.classList.add('selected');
            }

            if (selectedProblemCard && selectedAnswerCard) {
                const problemId = selectedProblemCard.id;
                const answerValue = selectedAnswerCard.answer;
                const correctProblem = level1Problems.find(p => p.id === problemId);

                if (correctProblem && correctProblem.answer === answerValue) {
                    matchCards(problemId, answerValue);
                } else {
                    setTimeout(() => {
                        if (selectedProblemCard && selectedProblemCard.id === problemId) {
                            selectedProblemCard.element.classList.remove('selected');
                        }
                        if (selectedAnswerCard && selectedAnswerCard.id === selectedAnswerCard.id) {
                            selectedAnswerCard.element.classList.remove('selected');
                        }
                        selectedProblemCard = null;
                        selectedAnswerCard = null;
                    }, 500);
                }
            }
        }

        function matchCards(problemId, answerValue) {
            matchedPairs++;
            const problemIndex = level1Problems.findIndex(p => p.id === problemId);
            if (problemIndex !== -1) level1Problems[problemIndex].isMatched = true;
            
            // DOM 조작을 위해 problem card와 answer card의 selected 클래스를 제거하고, 상태를 업데이트
            selectedProblemCard.element.classList.remove('selected');
            
            // renderCards가 전체를 다시 그리도록 호출
            renderLevel1Cards();
            
            selectedProblemCard = null;
            selectedAnswerCard = null;
            if (matchedPairs === 9) {
                // 1단계 완료 메시지 출력 로직 복구
                showCompletionMessage(1);
            }
        }

        /* ---------------- 2단계 ---------------- */
        function loadLevel2Cards(dan, reverse) {
            level2ProblemSet = generateGugudanSet(dan, reverse);
            flippedIndices = [];
            level2FlipCount = 1;
            document.getElementById('flip-count-display').textContent = level2FlipCount;
            renderLevel2Cards(true);
            document.getElementById('level2-completion-message').style.display = 'none';
        }

        function renderLevel2Cards(showAllAnswers = true) {
            const problemRow = document.getElementById('level2-problem-area-row');
            problemRow.innerHTML = '';
            
            level2ProblemSet.forEach((item, index) => {
                const pairContainer = document.createElement('div');
                pairContainer.className = 'level2-pair';
                pairContainer.setAttribute('data-index', index);

                const problemText = document.createElement('div');
                problemText.className = 'level2-problem-text';
                problemText.textContent = `${item.problem}`;
                pairContainer.appendChild(problemText);

                const answerBox = document.createElement('div');
                answerBox.className = 'level2-answer-box';
                
                if (flippedIndices.includes(index) && !showAllAnswers) {
                    answerBox.className += ' flipped';
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.min = '1';
                    input.max = '81';
                    input.className = 'level2-input';
                    input.setAttribute('data-answer', item.answer);
                    input.setAttribute('data-index', index);
                    answerBox.appendChild(input);
                } else {
                    answerBox.textContent = item.answer;
                }
                
                pairContainer.appendChild(answerBox);
                problemRow.appendChild(pairContainer);
            });
        }

        function changeFlipCount(delta) {
            level2FlipCount = Math.max(1, Math.min(9, level2FlipCount + delta));
            document.getElementById('flip-count-display').textContent = level2FlipCount;
        }

        function flipRandomCards() {
            renderLevel2Cards(true);
            const allIndices = Array.from({length: 9}, (_, i) => i);
            flippedIndices = shuffle(allIndices).slice(0, level2FlipCount);
            renderLevel2Cards(false);
            document.querySelectorAll('.level2-pair').forEach(pair => pair.classList.remove('incorrect'));
            document.getElementById('level2-completion-message').style.display = 'none';
            document.getElementById('flip-cards-btn').disabled = false;
        }

        function checkLevel2Answers() {
            let inputsRemaining = 0; 
            const inputs = document.querySelectorAll('#level2-problem-area-row .level2-input');
            document.querySelectorAll('.level2-pair').forEach(pair => pair.classList.remove('incorrect'));

            if (flippedIndices.length === 0) {
                alert('카드를 먼저 뒤집어요! 버튼을 눌러 빈칸을 만들어 주세요.');
                return;
            }

            inputs.forEach(input => {
                const index = parseInt(input.getAttribute('data-index'));
                const correctAnswer = parseInt(input.getAttribute('data-answer'));
                const userAnswer = parseInt(input.value.trim());
                const pairElement = document.querySelector(`.level2-pair[data-index="${index}"]`);

                if (userAnswer === correctAnswer) {
                    const answerBox = input.parentElement;
                    answerBox.textContent = correctAnswer;
                    answerBox.classList.remove('flipped');
                } else {
                    pairElement.classList.add('incorrect');
                    inputsRemaining++;
                }
            });
            
            const inputsOnDOM = document.querySelectorAll('#level2-problem-area-row .level2-input').length; 
            if (inputsOnDOM === 0 && inputs.length > 0) { 
                showCompletionMessage(2); 
                document.getElementById('flip-cards-btn').disabled = false;
            } else if (inputsRemaining > 0) {
                const msgElement = document.getElementById('level2-completion-message'); 
                msgElement.innerHTML = `
                    <div>
                        <p style="font-size: 0.9em; color: #dc3545; font-weight: bold;">다시 한번 확인해볼까요? <br> 붉게 표시된 카드를 고쳐주세요!</p>
                    </div>
                `;
                msgElement.style.display = 'block';
                document.getElementById('flip-cards-btn').disabled = true;
            }
        }
        
        /* ---------------- 3단계 ---------------- */
        function updateLevel3Status() {
            const total = level3Accuracy.totalProblems;
            const scoreSum = level3Accuracy.scoreSum;
            let accuracy = 0;
            if (total > 0) accuracy = Math.round((scoreSum / total) * 100);
            else accuracy = 100;

            const statusElement = document.getElementById('level3-status');
            if (statusElement) {
                statusElement.innerHTML = `${total}문제를 풀었어요! 정확도: <span class="status-accuracy">${accuracy}%</span>`;
            }
        }

        function selectLevel3Mode(mode) {
            level3Mode = mode;
            const mode4ChoiceBtn = document.getElementById('mode-4choice-btn');
            const modeInputBtn = document.getElementById('mode-input-btn');
            mode4ChoiceBtn.textContent = '답 고르기';
            mode4ChoiceBtn.className = mode === '4choice' ? 'primary-btn' : 'secondary-btn';
            modeInputBtn.className = mode === 'input' ? 'primary-btn' : 'secondary-btn';

            document.getElementById('level3-mode-select-wrapper').style.display = 'none';
            document.getElementById('level3-options-area').style.display = mode === '4choice' ? 'grid' : 'none';
            document.getElementById('level3-input-area').style.display = mode === 'input' ? 'flex' : 'none';
            document.getElementById('level3-quiz-area').style.display = 'flex';

            setupLevel3Buttons();
            resetLevel3Accuracy();
            level3QuizGenerator.initAllSelectedDans();
            updateLevel3Status(); 
            generateNewLevel3Problem();
        }

        function setupLevel3Buttons() {
            const container = document.getElementById('level3-gugudan-select');
            container.innerHTML = '';
            selectedGugudans.clear();

            for (let dan = 2; dan <= 9; dan++) {
                const btn = document.createElement('button');
                btn.className = `secondary-btn gugudan-btn-${dan}`;
                btn.textContent = `${dan}단`;
                btn.setAttribute('data-dan', dan);
                btn.onclick = () => toggleLevel3Dan(dan, btn);
                container.appendChild(btn);
            }
            toggleLevel3Dan(2, document.querySelector('#level3-gugudan-select button[data-dan="2"]'));
        }

        function toggleLevel3Dan(dan, btn) {
            const danNum = dan;
            if (selectedGugudans.has(dan)) {
                if (selectedGugudans.size > 1) {
                    selectedGugudans.delete(dan);
                    btn.classList.remove('selected');
                    btn.style.backgroundColor = '#e9e9e9';
                    btn.style.color = '#333';
                }
            } else {
                selectedGugudans.add(dan);
                btn.classList.add('selected');
                btn.style.backgroundColor = DAN_COLORS[danNum];
                btn.style.color = DAN_TEXT_COLOR[danNum];
                isLevel3Random = false;
                document.getElementById('level3-random-btn').classList.remove('selected');
            }
            level3QuizGenerator.initAllSelectedDans();
            generateNewLevel3Problem();
        }

        function toggleRandomMode() {
            isLevel3Random = !isLevel3Random;
            const btn = document.getElementById('level3-random-btn');

            if (isLevel3Random) {
                selectedGugudans.clear();
                document.querySelectorAll('#level3-gugudan-select button').forEach(b => {
                    b.classList.remove('selected');
                    b.style.backgroundColor = '#e9e9e9';
                    b.style.color = '#333';
                });
                btn.classList.add('selected'); 
            } else {
                btn.classList.remove('selected'); 
                const defaultDanBtn = document.querySelector('#level3-gugudan-select button[data-dan="2"]');
                if (defaultDanBtn) toggleLevel3Dan(2, defaultDanBtn); 
                return; 
            }
            level3QuizGenerator.initAllSelectedDans();
            generateNewLevel3Problem();
        }

        // ------- 추가: 레벨3 컨트롤 enable/disable 유틸
        function disableLevel3Controls() {
            document.querySelectorAll('#level3-options-area button, #level3-submit-btn')
                .forEach(btn => btn.disabled = true);
        }
        function enableLevel3Controls() {
            document.querySelectorAll('#level3-options-area button, #level3-submit-btn')
                .forEach(btn => btn.disabled = false);
        }

        // ------- 교체: 안전한 문제 생성기
        function generateRandomProblem() {
            let availableDans = Array.from(isLevel3Random ? Array.from({length: 8}, (_, i) => i + 2) : selectedGugudans);
            if (availableDans.length === 0) availableDans = Array.from({length: 8}, (_, i) => i + 2);

            let solvableDans = availableDans.filter(d => 
                level3QuizGenerator.availableProblems[d] && 
                level3QuizGenerator.availableProblems[d].length > 0
            );
            
            if (solvableDans.length === 0) {
                level3QuizGenerator.initAllSelectedDans();
                solvableDans = availableDans.filter(d =>
                    level3QuizGenerator.availableProblems[d] && level3QuizGenerator.availableProblems[d].length > 0
                );
            }

            if (solvableDans.length === 0) {
                const dan = Math.floor(Math.random() * 8) + 2;   // 2~9
                const mul = Math.floor(Math.random() * 9) + 1;   // 1~9
                return { problem: `${dan} x ${mul}`, answer: dan * mul, id: dan * 10 + mul };
            }

            const dan = solvableDans[Math.floor(Math.random() * solvableDans.length)];
            const mul = level3QuizGenerator.availableProblems[dan].pop();
            return { problem: `${dan} x ${mul}`, answer: dan * mul, id: dan * 10 + mul };
        }

        function generateCloseWrongAnswers(correctAnswer) {
            const options = new Set();
            options.add(correctAnswer);

            let range = [-2, -1, 1, 2, -3, 3, -4, 4];
            let count = 0;
            
            while (options.size < 4 && count < 10) {
                let wrongAnswer;
                if (count < range.length) wrongAnswer = correctAnswer + range[count];
                else wrongAnswer = Math.floor(Math.random() * 81) + 1;
                
                if (wrongAnswer >= 1 && wrongAnswer <= 81 && !options.has(wrongAnswer)) {
                    options.add(wrongAnswer);
                }
                count++;
            }
            while (options.size < 4) options.add(Math.floor(Math.random() * 81) + 1);
            return Array.from(options);
        }

        function renderLevel3Options(correctAnswer) {
            const optionsArea = document.getElementById('level3-options-area');
            optionsArea.innerHTML = '';
            let optionArray = shuffle(generateCloseWrongAnswers(correctAnswer));

            optionArray.forEach(answer => {
                const btn = document.createElement('button');
                btn.textContent = answer;
                btn.onclick = (event) => checkLevel3Answer(answer, event.target);
                optionsArea.appendChild(btn);
            });
        }

        function generateNewLevel3Problem() {
          disableLevel3Controls();
          const msg = document.getElementById('level3-result-message');
          if (msg) msg.textContent = '';
          
          let newProblem;
          let guard = 0;
          do {
            newProblem = generateRandomProblem();
            guard++;
            if (guard > 20) break;
          } while (level3CurrentProblem && newProblem && newProblem.id === level3CurrentProblem.id);

          if (!newProblem || typeof newProblem.id === 'undefined') {
            level3QuizGenerator.initAllSelectedDans();
            newProblem = generateRandomProblem();
            if (!newProblem || typeof newProblem.id === 'undefined') {
              if (msg) {
                msg.textContent = '문제 생성에 문제가 있어요. 다시 시도 버튼을 눌러주세요.';
                msg.className = 'level3-result-message incorrect-msg';
              }
              enableLevel3Controls();
              return;
            }
          }

          level3CurrentProblem = newProblem;

          // ✅ 항상 리셋 (이전 사이클에 -1로 저장돼 있던 문제도 새로 풀 수 있게)
          level3Attempts[level3CurrentProblem.id] = 0;

          const problemArea = document.getElementById('level3-problem-area');
          problemArea.innerHTML = '';
          
          if (level3Mode === 'input') {
            // 3단계 입력 모드 레이아웃 변경
            // A x B = [] 형태로 표시
            problemArea.style.justifyContent = 'center'; // 문제 영역 중앙 정렬
            
            const problemText = document.createElement('span');
            problemText.textContent = `${level3CurrentProblem.problem} = `;
            problemText.id = 'level3-problem-text';
            problemArea.appendChild(problemText);

            const inputElement = document.createElement('input');
            inputElement.type = 'number';
            inputElement.id = 'level3-answer-input';
            inputElement.onkeydown = (event) => handleLevel3Input(event);
            
            problemArea.appendChild(inputElement);
            document.getElementById('level3-input-area').style.display = 'flex';
            
            // 입력 필드 스타일 리셋
            if(inputElement) inputElement.style.borderColor = '#ccc';
          } else {
            // 3단계 4지선다 모드
            problemArea.textContent = `${level3CurrentProblem.problem} = ?`;
            document.getElementById('level3-input-area').style.display = 'none';
          }

          if (level3Mode === '4choice') {
            const optionsArea = document.getElementById('level3-options-area');
            optionsArea.innerHTML = '';
            renderLevel3Options(level3CurrentProblem.answer);
          }

          enableLevel3Controls();
          const inputEl = document.getElementById('level3-answer-input');
          if (level3Mode === 'input' && inputEl) inputEl.focus();
        }

        function checkLevel3Answer(userAnswer = null, clickedButton = null) {
          disableLevel3Controls();

          const problemArea = document.getElementById('level3-problem-area');
          
          if (level3Mode === 'input') {
            const inputElement = document.getElementById('level3-answer-input');
            userAnswer = parseInt(inputElement?.value.trim());
            if (isNaN(userAnswer)) {
              const m = document.getElementById('level3-result-message');
              m.textContent = '💡 답을 입력해 주세요.';
              m.className = 'level3-result-message incorrect-msg';
              enableLevel3Controls();
              return;
            }
          }

          const messageElement = document.getElementById('level3-result-message');
          const problemId = level3CurrentProblem.id;

          // ✅ 음수(-1)로 남아 있으면 새 시도로 간주하고 0으로 복구
          if (level3Attempts[problemId] < 0) {
            level3Attempts[problemId] = 0;
          }

          level3Attempts[problemId]++;

          if (userAnswer === level3CurrentProblem.answer) {
            messageElement.textContent = '✨ 정답입니다! ✨';
            messageElement.className = 'level3-result-message correct-msg';

            calculateAccuracy(problemId, level3Attempts[problemId]);
            level3Attempts[problemId] *= -1; // 이번 사이클 정답 처리 표시

            if (level3Mode === '4choice' && clickedButton) {
              clickedButton.style.backgroundColor = '#4b8134';
              clickedButton.style.borderColor = '#4b8134';
              clickedButton.style.color = 'white';
            }
            
            if (level3Mode === 'input') {
                const inputElement = document.getElementById('level3-answer-input');
                if(inputElement) inputElement.style.borderColor = '#4b8134';
            }


            updateLevel3Status();

            setTimeout(() => {
              messageElement.textContent = '';
              checkAndAutoResetLevel3();
            }, 800);

          } else {
            messageElement.textContent =
              `🐛 틀렸어요. 다시 시도해보세요. (현재 ${level3Attempts[problemId]}회 시도)`;
            messageElement.className = 'level3-result-message incorrect-msg';

            if (level3Mode === '4choice' && clickedButton) {
              clickedButton.style.backgroundColor = '#ffeded';
              clickedButton.style.borderColor = '#dc3545';
              clickedButton.style.color = '#dc3545';
            }
            if (level3Mode === 'input') {
              const input = document.getElementById('level3-answer-input');
              if(input) {
                input.value = '';
                input.style.borderColor = '#dc3545';
                input.focus();
              }
            }

            enableLevel3Controls();
            if (level3Mode === '4choice' && clickedButton) {
              clickedButton.disabled = true;
            }
          }
        }
        
        function calculateAccuracy(problemId, attempts) {
            let score;
            const absoluteAttempts = Math.abs(attempts);

            if (absoluteAttempts === 1) score = 1.0;
            else if (absoluteAttempts === 2) score = 0.8;
            else if (absoluteAttempts === 3) score = 0.6;
            else if (absoluteAttempts === 4) score = 0.4;
            else score = 0.2;
            
            if (level3Attempts[problemId] >= 1) { 
                level3Accuracy.totalProblems++;
                level3Accuracy.scoreSum += score;
                if (absoluteAttempts === 1) level3Accuracy.correctOnFirstTry++;
                else level3Accuracy.retryCorrect++;
            }
        }

        function handleLevel3Input(event) {
            if (event.key === 'Enter') checkLevel3Answer();
        }

        function resetLevel3Accuracy() {
            level3Accuracy = {
                totalProblems: 0,
                correctOnFirstTry: 0,
                retryCorrect: 0,
                scoreSum: 0,
            };
            level3Attempts = {};
        }

        // ------- 교체: 자동 초기화 체크
        function checkAndAutoResetLevel3() {
            const isRandom = isLevel3Random || selectedGugudans.size === 0;
            const candidateDans = isRandom ? Array.from({length: 8}, (_, i) => i + 2) : Array.from(selectedGugudans);

            const hasSolvableProblem = candidateDans.some(d =>
                level3QuizGenerator.availableProblems[d] && level3QuizGenerator.availableProblems[d].length > 0
            );

            if (!hasSolvableProblem) {
                level3QuizGenerator.initAllSelectedDans();
            }
            generateNewLevel3Problem();
        }

        function finishLevel3() {
            if (level3Accuracy.totalProblems === 0) {
                alert('문제를 먼저 풀어주세요!');
                enableLevel3Controls();
                return;
            }
            showPage('level3-result-page'); 
            let finalAccuracy = 0;
            if (level3Accuracy.totalProblems > 0) {
                finalAccuracy = (level3Accuracy.scoreSum / level3Accuracy.totalProblems) * 100;
            }
            document.getElementById('final-accuracy').textContent = `${Math.round(finalAccuracy)}%`;
            document.getElementById('result-total-count').textContent = level3Accuracy.totalProblems;
            document.getElementById('result-first-try').textContent = level3Accuracy.correctOnFirstTry;
            document.getElementById('result-retry-count').textContent = level3Accuracy.retryCorrect; 
        }

        function showCompletionMessage(level) {
            const messageElementId = level === 1 ? 'level1-completion-message' : 'level2-completion-message';
            const messageElement = document.getElementById(messageElementId);
            const dan = currentGuGuDan;
            
            if (level === 1) {
                // 1단계 완료 메시지 출력 로직 복구
                 messageElement.innerHTML = `
                    <div>
                        🎉 ${dan}단을 완성했어요! 🎉
                        <p>다음 단계로 넘어갈까요, 아니면 다른 단을 계속 연습할까요?</p>
                        <div class="popup-buttons"></div>
                    </div>
                `;
                const continueBtn = createPopupButton('secondary-btn', '1단계 계속 하기', () => {
                    messageElement.style.display = 'none';
                    const nextDan = dan < 9 ? dan + 1 : 2;
                    selectGuGuDan(1, nextDan);
                });
                const nextLevelBtn = createPopupButton('primary-btn', '2단계로 넘어가기', () => {
                    messageElement.style.display = 'none';
                    startLevel(2, dan);
                });
                messageElement.querySelector('.popup-buttons').appendChild(continueBtn);
                messageElement.querySelector('.popup-buttons').appendChild(nextLevelBtn);
                
            } else if (level === 2) {
                 messageElement.innerHTML = `<div>🎉 ${dan}단을 완성했어요! 🎉</div>`;
            }
            messageElement.style.display = 'block';
        }

        function openQrPopup() { qrPopupOverlay.style.display = 'flex'; }
        function closeQrPopup() { qrPopupOverlay.style.display = 'none'; }
        
        document.addEventListener('DOMContentLoaded', () => {
            showPage('home-page');
            const mode4ChoiceBtn = document.getElementById('mode-4choice-btn');
            if (mode4ChoiceBtn) mode4ChoiceBtn.textContent = '답 고르기';
            
            // 초기 방향 버튼 텍스트 설정
            const directionBtn1 = document.getElementById('direction-btn');
            if (directionBtn1) directionBtn1.innerHTML = isReverse ? '&#8680;' : '&#8678;';
            const directionBtn2 = document.getElementById('direction-btn-l2');
            if (directionBtn2) directionBtn2.innerHTML = isReverse ? '&#8680;' : '&#8678;';
        });
    </script>

</body>
</html>
